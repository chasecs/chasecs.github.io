<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>ç¿»è¯‘ï¼šJavaScript Promises å®ç°åŸç†è¯¦è§£ï¼ˆJavaScript Promises ... In Wicked Detailï¼‰ - ç¼–ç¨‹æœ­è®° Programming Notes</title>
  <meta property="og:title" content="ç¿»è¯‘ï¼šJavaScript Promises å®ç°åŸç†è¯¦è§£ï¼ˆJavaScript Promises ... In Wicked Detailï¼‰ - ç¼–ç¨‹æœ­è®° Programming Notes" />
  <meta name="twitter:title" content="ç¿»è¯‘ï¼šJavaScript Promises å®ç°åŸç†è¯¦è§£ï¼ˆJavaScript Promises ... In Wicked â€¦" />
  <meta name="description" content=" Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œè®© javascript å¯ä»¥ä»æ‚ä¹±å›è°ƒå‡½æ•°ä¸­è§£è„±å‡ºæ¥ã€‚åæ¥ ES6 æ ‡å‡†æŠŠ Promise çº³å…¥å…¶ä¸­ï¼ŒåŸç”Ÿæä¾›äº† Promise å¯¹è±¡ã€‚Promise ä¹Ÿæˆä¸º ES6 æœ€ä¸»è¦çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ç½‘ä¸Šä»‹ç» promise ä½¿ç”¨æ–¹æ³•çš„æ–‡ç« å¾ˆå¤šï¼Œè§£é‡Šå…¶åŸç†å´å¾ˆå°‘ã€‚è¿™ç¯‡æ–‡ç« å¾ªåºæ¸è¿›åœ°å®ç°äº†ä¸€é promiseï¼Œåˆ†æé€å½»ï¼Œå¯¹äº†è§£ promise çš„å·¥ä½œåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚ä¸ºäº†åŠ æ·±å°è±¡ï¼Œæ‰€ä»¥æŠŠåŸæ–‡ç¿»è¯‘äº†ä¸€éã€‚">
  <meta property="og:description" content=" Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œè®© javascript å¯ä»¥ä»æ‚ä¹±å›è°ƒå‡½æ•°ä¸­è§£è„±å‡ºæ¥ã€‚åæ¥ ES6 æ ‡å‡†æŠŠ Promise çº³å…¥å…¶ä¸­ï¼ŒåŸç”Ÿæä¾›äº† Promise å¯¹è±¡ã€‚Promise ä¹Ÿæˆä¸º ES6 æœ€ä¸»è¦çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ç½‘ä¸Šä»‹ç» promise ä½¿ç”¨æ–¹æ³•çš„æ–‡ç« å¾ˆå¤šï¼Œè§£é‡Šå…¶åŸç†å´å¾ˆå°‘ã€‚è¿™ç¯‡æ–‡ç« å¾ªåºæ¸è¿›åœ°å®ç°äº†ä¸€é promiseï¼Œåˆ†æé€å½»ï¼Œå¯¹äº†è§£ promise çš„å·¥ä½œåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚ä¸ºäº†åŠ æ·±å°è±¡ï¼Œæ‰€ä»¥æŠŠåŸæ–‡ç¿»è¯‘äº†ä¸€éã€‚">
  <meta name="twitter:description" content=" Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œè®© javascript å¯ä»¥ä»æ‚ä¹±å›è°ƒå‡½æ•°ä¸­è§£è„±å‡ºæ¥ã€‚åæ¥ ES6 æ ‡å‡†æŠŠ Promise çº³å…¥å…¶ä¸­ï¼ŒåŸç”Ÿæä¾›äº† Promise å¯¹è±¡ã€‚Promise ä¹Ÿæˆä¸º ES6 æœ€ä¸»è¦çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ç½‘ä¸Šä»‹ç» promise ä½¿ç”¨æ–¹æ³•çš„æ–‡ç« å¾ˆå¤šï¼Œè§£é‡Šå…¶åŸç†å´å¾ˆå°‘ã€‚è¿™ç¯‡æ–‡ç« å¾ªåºæ¸è¿›åœ°å®ç°äº†ä¸€é promiseï¼Œåˆ†æé€å½»ï¼Œå¯¹äº†è§£ promise çš„å·¥ä½œåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚ä¸ºäº† â€¦">
  <meta name="author" content="ttimehc" />
  <meta property="og:site_name" content="ç¼–ç¨‹æœ­è®° Programming Notes" />
  <meta property="og:url" content="https://example.com/posts/2017-10-07-simplified-chinese-translation-of-javascript-promises-in-wicked-detail/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.74.3" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>

</head>
<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">ç¼–ç¨‹æœ­è®° Programming Notes</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

<div class="main" role="main">
  <article class="article">
    
    
    <h1 class="article-title">ç¿»è¯‘ï¼šJavaScript Promises å®ç°åŸç†è¯¦è§£ï¼ˆJavaScript Promises ... In Wicked Detailï¼‰</h1>
    
    <hr class="article-title-bottom">
    <ul class="article-meta">
      <li class="article-meta-date"><time>October 7, 2017</time>
      </li>
      <li class="article-meta-categories">
        <a href="/categories/javascript/">
          <i class="fas fa-folder"></i>
          javascript
        </a>&nbsp;
      </li>
    </ul>
    
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#æ›´æ–°æ—¥å¿—">æ›´æ–°æ—¥å¿—</a></li>
    <li><a href="#ç›®å½•">ç›®å½•</a></li>
    <li><a href="#ä¸ºä»€ä¹ˆ">ä¸ºä»€ä¹ˆ</a></li>
    <li><a href="#æœ€ç®€å•çš„ä¾‹å­">æœ€ç®€å•çš„ä¾‹å­</a>
      <ul>
        <li><a href="#a-nameå®šä¹‰promiseç±»å‹å®šä¹‰-promise-ç±»å‹"><!-- raw HTML omitted -->å®šä¹‰ Promise ç±»å‹</a></li>
        <li><a href="#å½“å‰çš„ä»£ç æ—¢è„†å¼±åˆä¸å¥½">å½“å‰çš„ä»£ç æ—¢è„†å¼±åˆä¸å¥½</a></li>
      </ul>
    </li>
    <li><a href="#a-namepromisesçš„çŠ¶æ€promises-çš„çŠ¶æ€"><!-- raw HTML omitted -->Promises çš„çŠ¶æ€</a></li>
    <li><a href="#a-nameå®ç°promisesé“¾-å®ç°-promisesé“¾"><!-- raw HTML omitted -->å®ç° Promisesé“¾</a>
      <ul>
        <li><a href="#å›è°ƒæ˜¯å¯é€‰é¡¹">å›è°ƒæ˜¯å¯é€‰é¡¹</a></li>
        <li><a href="#a-nameåœ¨promiseé“¾ä¸­è¿”å›promise-åœ¨-promise-é“¾é‡Œè¿”å›-promise-ç±»å‹"><!-- raw HTML omitted -->åœ¨ Promise é“¾é‡Œè¿”å› Promise ç±»å‹</a></li>
      </ul>
    </li>
    <li><a href="#a-namepromisesçš„reject-promises-çš„-reject"><!-- raw HTML omitted -->Promises çš„ Reject</a>
      <ul>
        <li><a href="#a-nameæœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ°reject-æœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ°-reject"><!-- raw HTML omitted -->æœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ° Reject</a></li>
        <li><a href="#a-namepromiseså¯èƒ½ä¼šåƒæ‰é”™è¯¯-promises-å¯èƒ½ä¼šåƒæ‰é”™è¯¯"><!-- raw HTML omitted -->Promises å¯èƒ½ä¼šâ€œåƒæ‰â€é”™è¯¯</a></li>
        <li><a href="#a-nameä½¿ç”¨doneæ¥æŒ½æ•‘-ä½¿ç”¨-done-æ¥æŒ½æ•‘"><!-- raw HTML omitted -->ä½¿ç”¨ <code>done()</code> æ¥æŒ½æ•‘</a></li>
        <li><a href="#a-nameä»rejectä¸­æŒ½æ•‘å›æ¥-ä»-reject-ä¸­æŒ½æ•‘å›æ¥"><!-- raw HTML omitted -->ä» Reject ä¸­æŒ½æ•‘å›æ¥</a></li>
      </ul>
    </li>
    <li><a href="#a-namepromiseå¿…é¡»æ˜¯å¼‚æ­¥çš„-promise-å¿…é¡»æ˜¯å¼‚æ­¥çš„"><!-- raw HTML omitted -->Promise å¿…é¡»æ˜¯å¼‚æ­¥çš„</a>
      <ul>
        <li><a href="#a-nameä¸ºä»€ä¹ˆpromisesaè§„èŒƒè¦æ±‚å¼‚æ­¥-ä¸ºä»€ä¹ˆ-promisesa-è§„èŒƒè¦æ±‚å¼‚æ­¥"><!-- raw HTML omitted -->ä¸ºä»€ä¹ˆ Promises/A+ è§„èŒƒè¦æ±‚å¼‚æ­¥ï¼Ÿ</a></li>
      </ul>
    </li>
    <li><a href="#a-nameå‡†å¤‡å°è£…thenpromiseä¹‹å‰-å‡†å¤‡å°è£…-thenpromise-ä¹‹å‰"><!-- raw HTML omitted -->å‡†å¤‡å°è£… then/promise ä¹‹å‰</a></li>
    <li><a href="#ç»“è®º">ç»“è®º</a></li>
    <li><a href="#å»¶ä¼¸é˜…è¯»">å»¶ä¼¸é˜…è¯»</a></li>
    <li><a href="#ç¿»è¯‘">ç¿»è¯‘</a></li>
  </ul>
</nav>
</aside>
    <blockquote>
</blockquote>
<p><strong>è¯‘æŒ‰ï¼š</strong>
<em>Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œè®© javascript å¯ä»¥ä»æ‚ä¹±å›è°ƒå‡½æ•°ä¸­è§£è„±å‡ºæ¥ã€‚åæ¥ ES6 æ ‡å‡†æŠŠ Promise çº³å…¥å…¶ä¸­ï¼ŒåŸç”Ÿæä¾›äº† Promise å¯¹è±¡ã€‚Promise ä¹Ÿæˆä¸º ES6 æœ€ä¸»è¦çš„ç‰¹æ€§ä¹‹ä¸€ã€‚</em><br>
<em>ç½‘ä¸Šä»‹ç» promise ä½¿ç”¨æ–¹æ³•çš„æ–‡ç« å¾ˆå¤šï¼Œè§£é‡Šå…¶åŸç†å´å¾ˆå°‘ã€‚è¿™ç¯‡æ–‡ç« å¾ªåºæ¸è¿›åœ°å®ç°äº†ä¸€é promiseï¼Œåˆ†æé€å½»ï¼Œå¯¹äº†è§£ promise çš„å·¥ä½œåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚ä¸ºäº†åŠ æ·±å°è±¡ï¼Œæ‰€ä»¥æŠŠåŸæ–‡ç¿»è¯‘äº†ä¸€éã€‚</em></p>
<blockquote>
</blockquote>
<p><strong>åŸæ–‡ï¼š</strong> <a href="http://www.mattgreer.org/articles/promises-in-wicked-detail/">JavaScript Promises &hellip; In Wicked Detail</a></p>
<blockquote>
</blockquote>
<p>æˆ‘åœ¨è‡ªå·±çš„ JavaScript ä»£ç é‡Œä½¿ç”¨ promises æœ‰ä¸€æ®µæ—¶é—´äº†ã€‚åˆšå¼€å§‹ä½¿ç”¨çš„æ—¶å€™ç¡®å®æœ‰äº›è´¹è§£ï¼Œä½†ç°åœ¨å·²ç»é©¾è½»å°±ç†Ÿã€‚ä¸è¿‡ä»”ç»†æƒ³èµ·æ¥ï¼Œæˆ‘å¹¶ä¸æ˜¯å®Œå…¨æ˜ç™½å®ƒçš„åŸç†ã€‚å†™è¿™ç¯‡æ–‡ç« çš„ç›®çš„å°±æ˜¯ä¸ºäº†å¼„æ˜ç™½å®ƒã€‚å¦‚æœä½ åšæŒçœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œä½ ä¹Ÿèƒ½å¾ˆå¥½åœ°ç†è§£ promiseã€‚</p>
<p>æˆ‘ä»¬å°†æ¸è¿›å¼åœ°å®ç°ä¸€ä¸ª promiseï¼Œæœ€ç»ˆç‰ˆæœ¬ä¼šåŸºæœ¬ç¬¦åˆ <a href="http://promises-aplus.github.io/promises-spec/">Promises/A+ è§„èŒƒ</a>ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿä¼šæ˜ç™½ promise æ˜¯æ€æ ·å»æ»¡è¶³å¼‚æ­¥ç¼–ç¨‹çš„éœ€æ±‚ã€‚æœ¬æ–‡å‡å®šä½ å·²ç»å¯¹ promises æœ‰ä¸€å®šçš„äº†è§£ã€‚å¦‚æœä½ è¿˜ä»€ä¹ˆéƒ½ä¸çŸ¥é“ï¼Œå¯ä»¥å…ˆå» <a href="http://promisejs.org/">promisejs.org</a> çœ‹çœ‹ã€‚</p>
<h2 id="æ›´æ–°æ—¥å¿—">æ›´æ–°æ—¥å¿—</h2>
<ul>
<li>2017-10-07 Added a fiddle to the <a href="#%E5%BD%93%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%E6%97%A2%E8%84%86%E5%BC%B1%E5%8F%88%E4%B8%8D%E5%A5%BD">This Code is Brittle and Bad</a> section to demonstrate how it can fail.</li>
<li>2014-12-23: Added <a href="#%E4%BB%8EReject%E4%B8%AD%E6%8C%BD%E6%95%91%E5%9B%9E%E6%9D%A5">Recovering from Rejection</a> section. The article was a bit ambiguous on handling rejection, this new section should clear things up.</li>
</ul>
<h2 id="ç›®å½•">ç›®å½•</h2>
<ol>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88">ä¸ºä»€ä¹ˆ</a></li>
<li><a href="#%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90">æœ€ç®€å•çš„ä¾‹å­</a>
<ul>
<li><a href="#%E5%AE%9A%E4%B9%89Promise%E7%B1%BB%E5%9E%8B">å®šä¹‰ Promise ç±»å‹</a></li>
<li><a href="#%E5%BD%93%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%E6%97%A2%E8%84%86%E5%BC%B1%E5%8F%88%E4%B8%8D%E5%A5%BD">å½“å‰çš„ä»£ç æ—¢è„†å¼±åˆä¸å¥½</a></li>
</ul>
</li>
<li><a href="#Promises%E7%9A%84%E7%8A%B6%E6%80%81">Promises çš„çŠ¶æ€</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0Promises%E9%93%BE">å®ç° Promises é“¾</a>
<ul>
<li><a href="#%E5%9B%9E%E8%B0%83%E6%98%AF%E5%8F%AF%E9%80%89%E9%A1%B9">å›è°ƒæ˜¯å¯é€‰é¡¹</a></li>
<li><a href="#%E5%9C%A8Promise%E9%93%BE%E4%B8%AD%E8%BF%94%E5%9B%9EPromise">åœ¨ Promise é“¾ä¸­è¿”å› Promise</a></li>
</ul>
</li>
<li><a href="#Promises%E7%9A%84Reject">Promise çš„ Reject</a>
<ul>
<li><a href="#%E6%9C%AA%E7%9F%A5%E9%94%99%E8%AF%AF%E4%B9%9F%E5%BA%94%E8%AF%A5%E5%BD%92%E7%BA%B3%E5%88%B0Reject">æœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ° Reject</a></li>
<li><a href="#Promises%E5%8F%AF%E8%83%BD%E4%BC%9A%E2%80%9C%E5%90%83%E6%8E%89%E2%80%9D%E9%94%99%E8%AF%AF">Promises å¯èƒ½ä¼šâ€œåƒæ‰â€é”™è¯¯</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8done%E6%9D%A5%E6%8C%BD%E6%95%91">ä½¿ç”¨ <code>done()</code> æ¥æŒ½æ•‘</a></li>
<li><a href="#%E4%BB%8EReject%E4%B8%AD%E6%8C%BD%E6%95%91%E5%9B%9E%E6%9D%A5">ä» Reject ä¸­æŒ½æ•‘å›æ¥</a></li>
</ul>
</li>
<li><a href="#Promise%E5%BF%85%E9%A1%BB%E6%98%AF%E5%BC%82%E6%AD%A5%E7%9A%84">Promise å¿…é¡»æ˜¯å¼‚æ­¥çš„</a></li>
</ol>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88Promises/A+%E8%A7%84%E8%8C%83%E8%A6%81%E6%B1%82%E5%BC%82%E6%AD%A5">ä¸ºä»€ä¹ˆ Promises/A+ è§„èŒƒè¦æ±‚å¼‚æ­¥</a></li>
</ul>
<ol start="7">
<li><a href="#%E5%87%86%E5%A4%87%E5%B0%81%E8%A3%85then/promise%E4%B9%8B%E5%89%8D">å‡†å¤‡å°è£… then/promise ä¹‹å‰</a></li>
<li><a href="#%E7%BB%93%E8%AE%BA">ç»“è®º</a></li>
<li><a href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB">å»¶ä¼¸é˜…è¯»</a></li>
<li><a href="#%E7%BF%BB%E8%AF%91">ç¿»è¯‘</a></li>
</ol>
<h2 id="ä¸ºä»€ä¹ˆ">ä¸ºä»€ä¹ˆ</h2>
<p>ä¸ºä»€ä¹ˆè¦è´¹å¿ƒæ€å»æ·±å…¥ç†è§£ promise å‘¢ï¼Ÿå¼„æ¸…æ¥šå®ƒçš„å·¥ä½œæœºåˆ¶ï¼Œä½ å¯ä»¥æ›´å¥½åœ°è¿ç”¨å®ƒï¼Œå¹¶åœ¨å‡ºç°é—®é¢˜çš„æ—¶å€™æ›´å¥½åœ°æ’æŸ¥æ•…éšœã€‚æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„ç¼˜ç”±ï¼Œæ˜¯æœ‰ä¸€å›å’ŒåŒäº‹è¢«ä¸€ä¸ªæ£˜æ‰‹çš„ promise é—®é¢˜ç»™éš¾ä½äº†ï¼Œå¦‚æœæˆ‘å½“æ—¶åƒç°åœ¨è¿™ä¹ˆç†Ÿæ‚‰ promiseï¼Œå°±ä¸ä¼šä¸€ç­¹è«å±•ã€‚</p>
<h2 id="æœ€ç®€å•çš„ä¾‹å­">æœ€ç®€å•çš„ä¾‹å­</h2>
<p>æˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªæœ€ç®€å•çš„ promise ã€‚</p>
<p>æˆ‘ä»¬è¦æŠŠè¿™æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Got a value:&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>æ”¹é€ æˆè¿™æ ·:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Got a value:&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸ºæ­¤ï¼Œéœ€è¦æŠŠ <code>doSomething()</code> ä»ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
  <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ”¹æˆå¦‚ä¸‹åŸºäº &ldquo;promise&rdquo; çš„æ–¹æ¡ˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">then</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/zdgrC/1/">fiddle</a></p>
<p>å½“å‰çš„åšæ³•ä»…ä»…æ˜¯ç»™å›è°ƒæ¨¡å¼ï¼ˆcallback patternï¼‰çš„åŠ äº†ä¸€å±‚ç³–è¡£ï¼Œè¿˜æ²¡æœ‰ä»€ä¹ˆå®é™…ä½œç”¨ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æ‰åˆšèµ·æ­¥ï¼Œè€Œä¸”ä¹Ÿè§¦åŠåˆ°äº† promise çš„æ ¸å¿ƒæ€æƒ³ã€‚</p>
<blockquote>
<p>Promises æ•è·ä¸€ä¸ªæ¦‚å¿µä¸Šç§°ä½œç»ˆå€¼(eventual value)çš„ä¸œè¥¿ï¼Œå¹¶æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ªå¯¹è±¡(object)</p>
</blockquote>
<p>è¿™æ˜¯ä¸ºä»€ä¹ˆ promises å€¼å¾—ç©å‘³çš„åŸå› ã€‚å¦‚æœâ€œæœ€ç»ˆçš„ä¸œè¥¿â€å¯ä»¥è¢«æ•è·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å®ç°å¾ˆå¼ºå¤§çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å°†åœ¨ç¨åçš„æ–‡ç« ä¸­æ¢è®¨æ­¤äº‹ã€‚</p>
<h3 id="a-nameå®šä¹‰promiseç±»å‹å®šä¹‰-promise-ç±»å‹"><!-- raw HTML omitted -->å®šä¹‰ Promise ç±»å‹</h3>
<p>ä¸Šè¿°ä»£ç åªæ˜¯è¿”å›äº†ä¸€ä¸ªç®€å•çš„å¯¹è±¡ã€‚è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªçœŸæ­£çš„ Promise ç±»å‹ï¼Œå¹¶ä»¥å®ƒä¸ºåŸºç¡€æ¸è¿›æ‰©å±•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">fn</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨è¿™ä¸ª Promise ç±»å‹æ¥å®ç° <code>doSomething()</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å½“å‰çš„ä»£ç å­˜åœ¨ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœä½ è¿½æº¯æ•´ä¸ªæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œä½ ä¼šå‘ç° <code>resolve()</code> ä¼šåœ¨ <code>then()</code> ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¿™æ„å‘³ç€æ­¤æ—¶çš„ <code>callback</code> è¿˜æ˜¯ null ã€‚æˆ‘ä»¬æš‚æ—¶å…ˆç”¨ <code>setTimeout</code> æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// force callback to be called in the next
</span><span class="c1"></span>    <span class="c1">// iteration of the event loop, giving
</span><span class="c1"></span>    <span class="c1">// callback a chance to be set by then()
</span><span class="c1"></span>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">fn</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/uQrza/1/">fiddle</a></p>
<p>é€šè¿‡è¿™ä¸ªåŠæ³•ï¼Œè¿™æ®µä»£ç è¿˜æ˜¯å¯ä»¥è¿è¡Œçš„ï¼Œè™½ç„¶æœ‰äº›å‹‰å¼ºã€‚</p>
<h3 id="å½“å‰çš„ä»£ç æ—¢è„†å¼±åˆä¸å¥½">å½“å‰çš„ä»£ç æ—¢è„†å¼±åˆä¸å¥½</h3>
<p>ç›®å‰è¿™ä¸ªç®€é™‹çš„ promise å®ç°ç‰ˆæœ¬ï¼Œåªèƒ½åœ¨åŒæ­¥æ‰§è¡Œçš„ä»£ç ä¸­è¿è¡Œï¼ˆè¯‘æ³¨ï¼šåŸæ–‡ç”¨çš„è¯æ˜¯ asynchronicityï¼Œä¸ªäººè®¤ä¸ºæ˜¯å†™é”™äº†ï¼Œåº”è¯¥æ˜¯synchronicityï¼‰ã€‚åªè¦ <code>then()</code> ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œè¿™æ®µç¨‹åºå°±ä¼šå†æ¬¡å¤±è´¥ï¼Œ<code>callback</code> åˆä¼šå˜æˆ nullã€‚ä¸ºä»€ä¹ˆæˆ‘è¦åšè¿™ä¸ªé”™è¯¯çš„ç¤ºä¾‹å‘¢ï¼Œé‚£æ˜¯å› ä¸ºè¿™ä¸ªå®ç°ç‰ˆæœ¬çš„å¥½å¤„æ˜¯æµ…æ˜¾æ˜“æ‡‚ï¼Œè®©ä½ å…ˆäº†è§£ä¸ªå¤§æ¦‚ã€‚<code>then()</code> å’Œ <code>resolve()</code> ä¸‹æ¥ä¹Ÿä¼šç»§ç»­ä¿ç•™ç€ï¼Œå®ƒä»¬æ˜¯ promise çš„æ ¸å¿ƒæ¦‚å¿µã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­èƒ½è¡¨æ˜æˆ‘çš„æ„æ€ï¼š</p>
<p><a href="http://jsfiddle.net/3kku32vp/">fiddle</a></p>
<p>*è¯‘æ³¨ï¼šSTARTğŸ‘‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">()</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    	<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;got a value&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
		<span class="p">});</span>
<span class="p">},</span> <span class="mi">2</span><span class="p">);</span>

<span class="c1">//setTimeout å»¶è¿Ÿ `then()` çš„è°ƒç”¨ï¼Œå› æ­¤ promise å…ˆæ‰§è¡Œï¼Œæ­¤æ—¶ promise çš„ callback è¿˜æ˜¯ null
</span></code></pre></td></tr></table>
</div>
</div><p>*è¯‘æ³¨ï¼šENDğŸ‘†</p>
<p>å¦‚æœä½ æ‰“å¼€ consoleï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯æç¤ºï¼šcallback is not a function ã€‚å› ä¸º <code>then()</code> åœ¨ <code>setTimeout</code> é‡Œè°ƒç”¨.</p>
<h2 id="a-namepromisesçš„çŠ¶æ€promises-çš„çŠ¶æ€"><!-- raw HTML omitted -->Promises çš„çŠ¶æ€</h2>
<p>ä¸Šé¢é‚£ä¸ªä¸å¯é çš„å®ç°ç‰ˆæœ¬æé†’æˆ‘ä»¬ï¼ŒPromise åº”è¯¥æœ‰çŠ¶æ€æ ‡å¿—ã€‚æˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºæ‰§è¡Œå‰çŸ¥é“ï¼Œå½“å‰å¤„äºå“ªç§çŠ¶æ€ï¼Œå¹¶ä¿è¯çŠ¶æ€çš„æ­£ç¡®åœ°å˜æ›´ã€‚è¿™æ ·ç¨‹åºæ‰ä¼šå˜å¾—å¥å£®èµ·æ¥ã€‚</p>
<blockquote>
<ul>
<li>promise ç­‰å¾…ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒçš„çŠ¶æ€æ˜¯ pendingï¼Œè·å–ä¸€ä¸ªå€¼ä¹‹åï¼ŒçŠ¶æ€æ˜¯ resolved ã€‚</li>
<li>å½“ promise resolve ä¸€ä¸ªå€¼ï¼ˆvalueï¼‰ä¹‹åï¼Œå®ƒä¼šé”å®šé‚£ä¸ªå€¼ï¼Œä¸ä¼šå†æ¬¡ resolveã€‚</li>
</ul>
</blockquote>
<p>ï¼ˆpromise è¿˜éœ€è¦ä¸€ä¸ª rejected çš„çŠ¶æ€ï¼Œç”¨äºå¤„ç†å‘ç”Ÿé”™è¯¯çš„æƒ…å†µï¼Œæˆ‘ä»¬ç¨åå†æ¶‰åŠè¿™æ–¹é¢çš„å†…å®¹ï¼‰</p>
<p>è®©æˆ‘ä»¬åœ¨ promise é‡ŒåŠ å…¥çŠ¶æ€æ ‡å¿—ï¼Œæ›¿æ¢æ‰åŸæ¥çš„æš‚è¡ŒåŠæ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">deferred</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">onResolved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">onResolved</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">onResolved</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onResolved</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">onResolved</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">fn</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/QX85J/1/">fiddle</a></p>
<p>è™½ç„¶ä»£ç å˜å¾—æ¯”åŸæ¥å¤æ‚äº†ï¼Œä¸è¿‡ç°åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥è°ƒç”¨ <code>then()</code>ï¼Œ<code>resolve()</code> ä¹Ÿå¯ä»¥åœ¨éšæ—¶è¢«è°ƒç”¨ï¼Œä¸¤è€…ä¸å¿…è€ƒè™‘è°å…ˆè°åã€‚è¿™æ ·å°±å¯ä»¥åŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥çš„ä»£ç ã€‚</p>
<p>è¿™éƒ½æ˜¯å› ä¸ºæœ‰äº† state è¿™ä¸ªæ ‡å¿—ï¼Œ<code>then()</code> å’Œ <code>resolve()</code> éƒ½æŠŠåŸæ¥çš„å·¥ä½œäº¤ç»™äº† <code>handle()</code>ã€‚<code>handle()</code> å°†æ ¹æ®ä¸åŒ state ä½œå‡ºä»¥ä¸‹å¤„ç†ï¼š</p>
<ul>
<li>å¦‚æœ <code>then()</code> å…ˆäº <code>resolve()</code> è¢«è°ƒç”¨ï¼Œå½“å‰è¿˜æ²¡æœ‰ value å¯ä»¥äº¤ä»˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒçŠ¶æ€å°†æ˜¯ pendingï¼Œå›è°ƒæ–¹æ³• <code>onResolved</code> å°†è¢«è¢«æš‚æ—¶ä¿å­˜åˆ° <code>deferred</code>ã€‚ç›´åˆ° <code>resolve()</code> è¢«è°ƒç”¨åï¼Œå†äº¤ä»˜ value å¹¶è§¦å‘å¯„å­˜åœ¨ <code>deferred</code> çš„ <code>onResolved</code>ã€‚</li>
<li>å¦‚æœ <code>resolve()</code> å…ˆäº <code>then()</code> è¢«è°ƒç”¨ï¼Œvalue ä¼šè¢«ä¿å­˜ä¸‹æ¥ï¼Œå½“ <code>then()</code> è¢«è°ƒç”¨æ—¶ï¼Œvalue å°±å¯ä»¥äº¤ä»˜äº†ã€‚</li>
</ul>
<p>æ³¨æ„åˆ°æ²¡æœ‰ï¼Œç°åœ¨å·²ç»ä¸éœ€è¦ç”¨åˆ° <code>setTimeout</code> äº†ï¼Œä¸è¿‡è¿™åªæ˜¯æš‚æ—¶çš„ï¼Œç­‰ä¼šå„¿è¿˜è¦å†ç”¨åˆ°ã€‚</p>
<blockquote>
</blockquote>
<p>åœ¨ promises é‡Œï¼Œå¹¶ä¸è®²ç©¶ç¨‹åºæ‰§è¡Œçš„å…ˆåæ¬¡åºï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å†³å®šå…ˆè°ƒç”¨ <code>then()</code> è¿˜æ˜¯ <code>resolve()</code>ã€‚è¿™ä¹Ÿæ˜¯â€œâ€æ•è·ä¸€ä¸ªç»ˆå€¼å¹¶ä¿å­˜åˆ°å¯¹è±¡é‡Œâ€çš„å¼ºå¤§ä¹‹å¤„ã€‚</p>
<blockquote>
</blockquote>
<p>æŒ‰ Promises/A+ è§„èŒƒï¼Œæˆ‘ä»¬çš„ promises è¿˜æœ‰ä¸å°‘è¦å®Œå–„çš„åœ°æ–¹ï¼Œä¸è¿‡å½“å‰å·²ç»æŒºå¼ºå¤§çš„äº†ã€‚æˆ‘ä»¬å¯ä»¥å¤šæ¬¡è°ƒç”¨ <code>then()</code>ï¼Œæ¯æ¬¡éƒ½ä¼šå¾—åˆ°ç›¸åŒçš„è¿”å›å€¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">();</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Got a value:&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Got the same value again:&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>å½“ç„¶ï¼Œå¯¹äºç›®å‰çš„ promise å®ç°ç‰ˆæœ¬ï¼Œè¿™ç§è¯´æ³•ä¹Ÿä¸å®Œå…¨æ˜¯å¯¹çš„ã€‚å¯èƒ½ä¼šæœ‰ç›¸åçš„æƒ…å†µ: æ¯”å¦‚ï¼Œåœ¨ <code>resolve()</code> è°ƒç”¨ä¹‹å‰ï¼Œå¤šæ¬¡è°ƒç”¨ <code>then()</code>ï¼Œåªä¼šæˆåŠŸå…‘ç°æœ€åä¸€æ¬¡è°ƒç”¨çš„ <code>then()</code>ã€‚å¯¹äºè¿™ç§æƒ…å†µæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šæŠŠ promise é‡Œæ‰€æœ‰çš„ deferreds éƒ½ä¿å­˜åœ¨ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œè€Œä¸æ˜¯åƒç°åœ¨åªä¿å­˜åœ¨ä¸€ä¸ªå˜é‡é‡Œã€‚ä¸ºäº†ä¸è®©æœ¬æ–‡å˜å¾—æ›´å¤æ‚ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œå®ç°è¿™ä¸ªç‰¹æ€§ã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<h2 id="a-nameå®ç°promisesé“¾-å®ç°-promisesé“¾"><!-- raw HTML omitted -->å®ç° Promisesé“¾</h2>
<p>promise å¯ä»¥å¼‚æ­¥åœ°æ•è·ä¸€ä¸ªæ¦‚å¿µå¹¶ä¿å­˜åˆ°å¯¹è±¡é‡Œï¼ˆcapture the notion of asynchronicity in an object)ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥
å®ç° promise é“¾ï¼Œæ˜ å°„ promisesï¼Œè®©å®ƒä»¬ä¾åºæˆ–è€…å¹³è¡Œåœ°è¿è¡Œâ€¦â€¦ä»¥ä¸‹çš„ä»£ç åœ¨ promise ä¸­å¾ˆå¸¸è§ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">getSomeData</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">filterTheData</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">processTheData</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">displayTheData</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><code>getSomeData</code> è¿”å›ä¸€ä¸ª promiseï¼Œå¹¶è°ƒç”¨ <code>then()</code>ï¼Œè€Œç¬¬ä¸€ä¸ª then è¿”å›çš„ï¼Œä¹Ÿå¿…é¡»æ˜¯ä¸€ä¸ª promiseï¼Œç„¶åæ‰å¯ä»¥ä¸æ–­åœ°è°ƒç”¨ <code>then()</code>ã€‚</p>
<blockquote>
<p><code>then()</code> æ€»æ˜¯è¿”å›ä¸€ä¸ª promise</p>
</blockquote>
<p>å®ç°äº†é“¾çš„ promise ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">.</span><span class="nx">onResolved</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">onResolved</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onResolved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">({</span>
        <span class="nx">onResolved</span><span class="o">:</span> <span class="nx">onResolved</span><span class="p">,</span>
        <span class="nx">resolve</span><span class="o">:</span> <span class="nx">resolve</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">fn</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/HdzLv/2/">fiddle</a></p>
<p>å—¯ï¼Œä»£ç å¼€å§‹æœ‰ç‚¹å¤æ€ªäº†ï¼Œä½ åº”è¯¥åº†å¹¸æˆ‘ä»¬æ…¢æ…¢åœ°æ„å»ºè¿™ä¸€åˆ‡ã€‚è¿™ä¸ªç¯èŠ‚æœ€å…³é”®å°±æ˜¯ï¼Œ<code>then()</code> è¿”å›ä¸€ä¸ªæ–°çš„ promise ã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>ç”±äº <code>then()</code> æ€»æ˜¯ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡ï¼Œè¿™æ„å‘³ç€è‡³å°‘æœ‰ä¸€ä¸ª promise å¯¹è±¡è¢«åˆ›å»º(created)ã€å¤„ç†(resolved)ï¼Œæœ€ç»ˆå´è¢«æ— è§†(ignored)ã€‚è¿™ç§æƒ…å†µä¹Ÿè¢«è§†ä¸ºä¸€ç§æµªè´¹ï¼Œå›è°ƒæ¨¡å¼å°±ä¸å­˜åœ¨è¿™ç§é—®é¢˜ã€‚è¿™æ˜¯ promise çš„ä¸€ä¸ªå¼Šç«¯ï¼Œæƒ³å¿…ç°åœ¨ä½ ä¹Ÿèƒ½ç†è§£ä¸ºä»€ä¹ˆ Javascript åœˆå­é‡Œæœ‰äººä¼šä¸å–œæ¬¢ promiseã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>é‚£ä¹ˆï¼Œç¬¬äºŒä¸ª promise çš„è¦ resolve çš„å€¼åœ¨å“ªé‡Œå‘¢ï¼Ÿå®ƒæ¥è‡ªç¬¬ä¸€ä¸ª promise çš„è¿”å›å€¼ï¼Œåœ¨ <code>handle()</code> æ–¹æ³•çš„æœ€åéƒ¨åˆ†å®ç°ã€‚ <code>handler</code> å¯¹è±¡åŒ…å«äº†ä¸€ä¸ª <code>onResolved</code> å›è°ƒæ–¹æ³•å’Œä¸€ä¸ª <code>resolve()</code> çš„å¼•ç”¨ï¼ˆreferenceï¼‰ã€‚å› ä¸ºæœ‰ä¸åªä¸€ä¸ª <code>resolve()</code> æ–¹æ³•ï¼Œæ¯ä¸ª promise éƒ½ä¼šå¤åˆ¶å±äºè‡ªèº«çš„ <code>resolve()</code> æ–¹æ³•ï¼Œä»¥åŠä¸€ä¸ªè¿è¡Œè¯¥æ–¹æ³•çš„é—­åŒ…ã€‚è¿™ä¹Ÿæ˜¯ä»ç¬¬ä¸€ä¸ª promise è¿‡æ¸¡åˆ°ç¬¬äºŒä¸ª promise çš„æ¡¥æ¢ã€‚</p>
<p>æˆ‘ä»¬æŠŠç¬¬ä¸€ä¸ª promise å½’ç»“åˆ°è¿™è¡Œä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">onResolved</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>handler.onResolved</code> ç›¸å½“äºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Got a value:&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¢å¥è¯è¯´ï¼Œå…ˆæœ‰ä¸€ä¸ª value è¢«ä¼ åˆ°ç¬¬ä¸€ä¸ª <code>then()</code>ï¼Œç„¶åç¬¬ä¸€ä¸ª <code>handler</code> çš„è¿”å›å€¼åˆ™ç”¨äº resolve ç¬¬äºŒä¸ª promise çš„å€¼ï¼Œè¿™æ ·å°±å®ç°äº† promise é“¾ ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;first result&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">88</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">secondResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;second result&#39;</span><span class="p">,</span> <span class="nx">secondResult</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// the output is
</span><span class="c1">//
</span><span class="c1">// first result 42
</span><span class="c1">// second result 88
</span><span class="c1"></span>
<span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;first result&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
  <span class="c1">// not explicitly returning anything
</span><span class="c1"></span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">secondResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;second result&#39;</span><span class="p">,</span> <span class="nx">secondResult</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// now the output is
</span><span class="c1">//
</span><span class="c1">// first result 42
</span><span class="c1">// second result undefined
</span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸º <code>then()</code> æ€»æ˜¯ä¼šè¿”å›ä¸€ä¸ª promiseï¼Œæ‰€ä»¥è¿™ä¸ª promise é“¾å¯ä»¥æ— é™å»¶é•¿ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;first result&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">88</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">secondResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;second result&#39;</span><span class="p">,</span> <span class="nx">secondResult</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">99</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">thirdResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;third result&#39;</span><span class="p">,</span> <span class="nx">thirdResult</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">200</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fourthResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// on and on...
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>å‡å¦‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è¦åœ¨æœ€åæ”¶é›†æ•´ä¸ª promise é“¾çš„æ¯ä¸€ä¸ªè¿”å›å€¼ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿåˆ©ç”¨è¿™æ®µ promise é“¾ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ„å»ºè¿”å›çš„ç»“æœï¼š</p>
<pre><code>doSomething().then(function(result) {
  var results = [result];
  results.push(88);
  return results;
}).then(function(results) {
  results.push(99);
  return results;
}).then(function(results) {
  console.log(results.join(',');
});
// the output is
//
// 42, 88, 99
</code></pre><blockquote>
</blockquote>
<p>Promises åªä¼š resolve ä¸€ä¸ªå€¼ value ã€‚å¦‚æœä½ éœ€è¦ä¼ é€’è¶…è¿‡ä¸€ä¸ªå€¼ï¼Œå°±éœ€è¦æŠŠå¤šä¸ªå€¼æ”¹å¤´æ¢é¢åŒ…è£…èµ·æ¥ï¼ˆæ¯”å¦‚ç”¨æ•°ç»„ã€å¯¹è±¡ï¼Œåˆå¹¶å­—ç¬¦ä¸²ï¼Œç­‰ç­‰ï¼‰ã€‚</p>
<blockquote>
</blockquote>
<p>æ›´å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨ promise çš„ <code>all()</code> æ–¹æ³•ï¼Œæˆ–è€…å…¶å®ƒçš„å·¥å…·æ–¹æ³•ï¼Œå®ƒä»¬æ‹“å±•äº† promise çš„å¯ç”¨æ€§ï¼Œä¸‹æ¥ä¹Ÿå°†ä¼šæ¢è®¨è¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<h3 id="å›è°ƒæ˜¯å¯é€‰é¡¹">å›è°ƒæ˜¯å¯é€‰é¡¹</h3>
<p><code>then()</code> æ–¹æ³•é‡Œçš„å›è°ƒå¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä½ çœç•¥å®ƒï¼Œéšåçš„ promise ä¼šæ¥ç€ resolve ä¸Šä¸€ä¸ª promise è¿”å›çš„å€¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;got a result&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// the output is
</span><span class="c1">//
</span><span class="c1">// got a result 42
</span></code></pre></td></tr></table>
</div>
</div><p>ä¸ªä¸­åŸå› å¯ä»¥åœ¨ <code>handle()</code>é‡Œå‘ç°ï¼Œå‡å¦‚æ²¡æœ‰å›è°ƒï¼Œå®ƒå°±ä¼š resolve ä¸Šä¸€ä¸ª promise ç•™ä¸‹çš„å€¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">.</span><span class="nx">onResolved</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="a-nameåœ¨promiseé“¾ä¸­è¿”å›promise-åœ¨-promise-é“¾é‡Œè¿”å›-promise-ç±»å‹"><!-- raw HTML omitted -->åœ¨ Promise é“¾é‡Œè¿”å› Promise ç±»å‹</h3>
<p>å½“å‰çš„ promise é“¾è¿˜æ˜¯æœ‰äº›åˆçº§ï¼Œå®ƒåªä¼šæœºæ¢°åœ°æŠŠ resolve ä¹‹åçš„å€¼ä¼ é€’ä¸‹å»ã€‚å‡å¦‚å…¶ä¸­ä¸€ä¸ªè¢« resolve çš„å€¼æ˜¯ promise â€”â€”å°±åƒä¸‹é¢è¿™æ®µä»£ç â€”â€”ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// doSomethingElse returns a promise
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">doSomethingElse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">finalResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;the final result is&#34;</span><span class="p">,</span> <span class="nx">finalResult</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚ä»£ç æ‰§è¡Œçš„ç»“æœæ‰€ç¤ºï¼Œ<code>finalResult</code> ä¸æ˜¯ä¸€ä¸ª resolve ä¹‹åçš„å€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ª promiseï¼Œå¦‚æœè¦å¾—åˆ°é¢„æœŸçš„ç»“æ„ï¼Œéœ€è¦è¿™æ ·ä¿®æ”¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// doSomethingElse returns a promise
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">doSomethingElse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">anotherPromise</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">anotherPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">finalResult</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;the final result is&#34;</span><span class="p">,</span> <span class="nx">finalResult</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½†è°ä¼šå¸Œæœ›ä»£ç è¿™æ ·ä¹±ç³Ÿç³Ÿçš„ï¼Ÿå†æ”¹è¿›ä¸€ä¸‹å®ç° promise çš„ä»£ç ï¼Œå°±å¯ä»¥ä¼˜é›…åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚
åœ¨ <code>resolve()</code> æ–¹æ³•é‡Œå¢åŠ ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå¤„ç† promise çš„æƒ…å†µï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">newValue</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">newValue</span><span class="p">.</span><span class="nx">then</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">newValue</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span><span class="p">;</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/38CCb/2/">fiddle</a></p>
<p>å¦‚æœæˆ‘ä»¬å¾—åˆ°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª promiseï¼Œå°±ä¼šå¾ªç¯åœ°è°ƒç”¨ <code>resolve()</code>ã€‚å½“è¿”å›å€¼ä¸æ˜¯ promise æ—¶ï¼Œå°±åƒä¹‹å‰é‚£æ ·æ‰§è¡Œã€‚</p>
<blockquote>
<blockquote>
<p>è¿™é‡Œä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºç°æ— é™å¾ªç¯çš„æƒ…å†µï¼ŒPromises/A+ è§„èŒƒå»ºè®®å®ç° promise æ—¶è¦æ£€æµ‹æ— é™å¾ªç¯çš„æƒ…å†µï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ã€‚</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>è¿˜æœ‰éœ€è¦æŒ‡å‡ºçš„ä¸€ç‚¹ï¼Œè¿™é‡Œä¸Šè¿°åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸º promise çš„æ–¹æ³•å¹¶ä¸ç¬¦åˆ Promises/A+ è§„èŒƒï¼Œè¿™ç¯‡æ–‡ç« çš„å†…å®¹ä¹Ÿæ²¡æœ‰å®Œå…¨ç¬¦åˆ Promises/A+ è§„èŒƒã€‚å¦‚æœä½ å¯¹è¿™æ–¹é¢çš„å†…å®¹æ„Ÿåˆ°å¥½å¥‡ï¼Œå»ºè®®ä½ é˜…è¯»è¿™ä¸€èŠ‚ <a href="https://promisesaplus.com/#the-promise-resolution-procedure">promise resolution procedure</a>.</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆ¤æ–­ <code>newValue</code> æ˜¯å¦ä¸º promise çš„æ–¹æ³•æ˜¯å¾ˆå®½æ¾çš„ï¼Œåªåˆ¤æ–­è¿”å›å€¼æ˜¯å¦æœ‰ä¸€ä¸ª <code>then()</code> æ–¹æ³•ã€‚æˆ‘è¿™ç§ <a href="https://en.wikipedia.org/wiki/Duck_typing">duck typing</a> çš„åšæ³•å…¶å®æ˜¯æ•…æ„çš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä¸åŒçš„ promise å®ç°ç‰ˆæœ¬å°±å¯ä»¥ååŒä½¿ç”¨ï¼ˆinteroptï¼‰ã€‚å®é™…ä¸Šï¼Œä¸åŒ promise åº“ä¹‹å‰æ··ç”¨æ˜¯å¾ˆå¸¸è§çš„ï¼Œä½ åœ¨ä½¿ç”¨ä¸åŒçš„ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œå®ƒä»¬ä¹Ÿå¯èƒ½ä½¿ç”¨ä¸åŒçš„ promise å®ç°æ–¹æ³•ã€‚</p>
<blockquote>
<p>ä¸åŒçš„ promise å®ç°æ–¹æ³•å¯ä»¥ååŒä½¿ç”¨ï¼ˆinteroptï¼‰ï¼Œåªè¦å®ƒä»¬éƒ½æ°å¦‚å…¶åˆ†åœ°éµç…§ Promises/A+ è§„èŒƒ</p>
</blockquote>
<p>å®ç°äº† promise é“¾ä¹‹åï¼Œå½“å‰çš„ç‰ˆæœ¬å·²ç»ç›¸å¯¹æ¯”è¾ƒå®Œå–„äº†ï¼Œä½†è¿˜ç¼ºå°‘é”™è¯¯å¤„ç†æœºåˆ¶ã€‚</p>
<h2 id="a-namepromisesçš„reject-promises-çš„-reject"><!-- raw HTML omitted -->Promises çš„ Reject</h2>
<p>å½“ promise æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯æ—¶ï¼Œéœ€è¦æœ‰ä¸€ä¸ªåŸå› æ¥ reject ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>then()</code> é‡Œä¼ å…¥ç¬¬äºŒä¸ªå›è°ƒæ–¹æ³•å¤„ç†è¿™ä¸€è¿‡ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Uh oh&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å¦‚å…ˆå‰æ‰€è¿°ï¼Œpromise çš„çŠ¶æ€å°†ä» pending è½¬å˜åˆ° resolved æˆ– rejected ä¹‹ä¸€ã€‚å› æ­¤ï¼Œ<code>then()</code> çš„ä¸¤ä¸ªå›è°ƒæ–¹æ³•åªæœ‰ä¸€ä¸ªä¼šè¢«è°ƒç”¨ã€‚</p>
</blockquote>
<p>Promises é€šè¿‡ <code>reject()</code> æ–¹æ³•æ¥å®ç°æ‹’ç»ï¼Œä»¥ä¸‹æ˜¯å®ç°äº†é”™è¯¯å¤„ç†çš„ <code>doSomething()</code> ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">somehowGetTheValue</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ promise çš„å®ç°æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åŠ å…¥ reject ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">newValue</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">newValue</span><span class="p">.</span><span class="nx">then</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newValue</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolved&#39;</span><span class="p">;</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">handlerCallback</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;resolved&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handlerCallback</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">onResolved</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">handlerCallback</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">onRejected</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">handlerCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;resolved&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">handlerCallback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onResolved</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handle</span><span class="p">({</span>
        <span class="nx">onResolved</span><span class="o">:</span> <span class="nx">onResolved</span><span class="p">,</span>
        <span class="nx">onRejected</span><span class="o">:</span> <span class="nx">onRejected</span><span class="p">,</span>
        <span class="nx">resolve</span><span class="o">:</span> <span class="nx">resolve</span><span class="p">,</span>
        <span class="nx">reject</span><span class="o">:</span> <span class="nx">reject</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">fn</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/rLXsL/2/">fiddle</a></p>
<p>é™¤äº†å¢åŠ äº† <code>reject()</code> æ–¹æ³•ï¼Œ<code>handle()</code> æ–¹æ³•ä¹Ÿè¦å¯¹ rejection ä½œå‡ºå¤„ç†ã€‚åœ¨ <code>handle()</code> æ–¹æ³•é‡Œï¼Œå°†æ ¹æ® <code>state</code> çš„çŠ¶æ€åˆ†åˆ«ä½œå‡º reject æˆ– resolve ã€‚è€Œå½“å‰çš„ <code>state</code> çš„ä¹Ÿä¼šè¢«ä¼ é€’åˆ°ä¸‹ä¸€ä¸ª promise ï¼Œä¸‹ä¸€ä¸ª promise çš„ <code>resolve()</code> æˆ– <code>reject()</code> æ–¹æ³•åŒæ ·ä¹Ÿä¼šæ”¹å˜å®ƒè‡ªèº«çš„ <code>state</code>ã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>ä½¿ç”¨ promise æ—¶ï¼Œå¾ˆå®¹æ˜“å¿½ç•¥å¤„ç†é”™è¯¯çš„å›è°ƒï¼Œè¿™æ ·ä½ å°±ä¸ä¼šå¾—åˆ°é”™è¯¯æç¤ºã€‚è‡³å°‘ä½ åº”è¯¥åœ¨ä½ çš„æœ€åä¸€ä¸ª promise é‡ŒåŠ ä¸Šé”™è¯¯å›è°ƒã€‚å…³äºè¿™ä¸ªé—®é¢˜ä½ å¯ä»¥æŸ¥çœ‹ä¸‹æ–‡â€œ promiseå¯èƒ½ä¼šâ€˜åƒæ‰â€™é”™è¯¯â€ä¸€èŠ‚çš„å†…å®¹</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<h3 id="a-nameæœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ°reject-æœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ°-reject"><!-- raw HTML omitted -->æœªçŸ¥é”™è¯¯åº”è¯¥å½’çº³åˆ° Reject</h3>
<p>ç›®å‰ï¼Œæˆ‘ä»¬çš„é”™è¯¯å¤„ç†åªé’ˆå¯¹å·²çŸ¥é”™è¯¯ã€‚å¯èƒ½æœ‰æœªçŸ¥çš„å¼‚å¸¸å‡ºç°ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæ‰€ä»¥æœ‰å¿…è¦åœ¨å®ç° promise æ—¶å¯¹æ„å¤–ä½œå‡ºæ­£ç¡®çš„ rejectï¼Œå³åœ¨ <code>resolve()</code> æ–¹æ³•é‡ŒåŠ å…¥ <code>try/catch</code> ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// ... as before
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–ï¼Œè¿˜å¾—ç¡®ä¿ä¼ å…¥ <code>handle()</code> å›è°ƒæ–¹æ³•ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ... as before
</span><span class="c1"></span>
  <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">ret</span> <span class="o">=</span> <span class="nx">handlerCallback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">handler</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="a-namepromiseså¯èƒ½ä¼šåƒæ‰é”™è¯¯-promises-å¯èƒ½ä¼šåƒæ‰é”™è¯¯"><!-- raw HTML omitted -->Promises å¯èƒ½ä¼šâ€œåƒæ‰â€é”™è¯¯</h3>
<blockquote>
<blockquote>
<p>promise ä¹Ÿæœ‰å¯èƒ½å› ä¸ºè¯¯è§£ï¼Œå¯¼è‡´é”™è¯¯è¢«åƒæ‰ï¼Œå¾ˆå¤šäººå°±è¢«è¿™ç§æƒ…å†µå‘è¿‡ã€‚</p>
</blockquote>
</blockquote>
<p>è¯·çœ‹ä»¥ä¸‹ä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kd">function</span> <span class="nx">getSomeJson</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">badJson</span> <span class="o">=</span> <span class="s2">&#34;&lt;div&gt;uh oh, this is not JSON at all!&lt;/div&gt;&#34;</span><span class="p">;</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">badJson</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">getSomeJson</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;uh oh&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://jsfiddle.net/city41/M7SRM/3/">fiddle</a></p>
<p>è¿™æ®µä»£ç å°†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<code>then()</code> æ–¹æ³•é‡Œçš„å›è°ƒæœŸæœ›å¾—åˆ°çš„æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå°±å¤©çœŸåœ°æŠŠç»“æœå½“ä½œ JSON æ¥è§£æï¼Œå¯¼è‡´å‘ç”Ÿå¼‚å¸¸ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å¤„ç†é”™è¯¯çš„å›è°ƒï¼Œä½†ç®¡ç”¨å—ï¼Ÿ</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>å®é™…ä¸Šï¼Œé”™è¯¯å›è°ƒå¹¶æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå¦‚æœä½ åœ¨ fiddle ä¸Šè¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¸ä¼šå¾—åˆ°ä»»ä½•è¾“å‡ºï¼Œæ²¡æœ‰é”™è¯¯ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿå› ä¸ºæœªå¤„ç†çš„å¼‚å¸¸å‘ç”Ÿåœ¨ <code>then()</code> çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå®ƒæ˜¯åœ¨ <code>handle()</code> æ–¹æ³•é‡Œè¢«æ•è·çš„ã€‚è¿™å¯¼è‡´ <code>hande()</code> æ–¹æ³• reject äº† <code>then()</code> è¿”å›çš„ promiseï¼Œè€Œä¸æ˜¯æ­£åœ¨å¤„ç†çš„ promiseï¼Œæ•´ä¸ªè¿‡ç¨‹å°±åƒ promise è¢«æ­£ç¡®çš„ resolve ä¸€æ ·ã€‚</p>
<blockquote>
</blockquote>
<p>è®°ä½ï¼Œåœ¨ <code>then()</code> çš„å›è°ƒé‡Œï¼Œä½ æ­£åœ¨å“åº”çš„ promise å·²ç»è¢« resolveï¼Œæ‰€ä»¥ä½ çš„å›è°ƒæ–¹æ³•å¯¹è¿™ä¸ª promise æ²¡æœ‰å½±å“</p>
<blockquote>
</blockquote>
<p>å¦‚æœä½ æƒ³æ•è·ä¸Šé¢çš„é‚£ä¸ªé”™è¯¯ï¼Œéœ€è¦åœ¨ä¸‹æ¸¸åŠ ä¸€ä¸ªé”™è¯¯å¤„ç†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">getSomeJson</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;an error occured: &#34;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å°±å¯ä»¥æ‰“å°å¤„é”™è¯¯æ—¥å¿—äº†ã€‚</p>
<blockquote>
<blockquote>
<p>æŒ‰æˆ‘çš„ä¸ªäººç»éªŒï¼Œè¿™æ˜¯ promise æœ€å¤§çš„ç¼ºé™·ã€‚ä¸‹ä¸€èŠ‚ä»‹ç»äº†ä¸€ä¸ªæ›´å¥½çš„åŠæ³•â€”â€”<code>done()</code>â€”â€”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
</blockquote>
<h3 id="a-nameä½¿ç”¨doneæ¥æŒ½æ•‘-ä½¿ç”¨-done-æ¥æŒ½æ•‘"><!-- raw HTML omitted -->ä½¿ç”¨ <code>done()</code> æ¥æŒ½æ•‘</h3>
<p>å¤§éƒ¨åˆ†ï¼ˆå¹¶éæ‰€æœ‰ï¼‰promise åº“éƒ½æœ‰ä¸€ä¸ª <code>done()</code> æ–¹æ³•ã€‚å®ƒå’Œ <code>then()</code> å¾ˆåƒï¼Œå¹¶ä¸”æ²¡æœ‰ä¸Šé¢æåˆ°çš„ç¼ºé™·ã€‚</p>
<p>ä»»ä½•å¯ä»¥ä½¿ç”¨ <code>then()</code> çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ <code>done()</code>ï¼Œå®ƒçš„ä¸»è¦ä¸åŒç‚¹åœ¨äºä¸ä¼šè¿”å›ä¸€ä¸ª promiseï¼Œè€Œä¸”ä»»ä½•å‘ç”Ÿåœ¨ <code>done()</code> å‘ç”Ÿçš„å¼‚å¸¸ï¼Œä¸ä¼šè¢« promise çš„å®ç°æœºåˆ¶æ•è·ã€‚æ¢å¥è¯è¯´ï¼Œ<code>done()</code> è¡¨ç¤ºæ•´ä¸ª promise é“¾éƒ½è¢« resolve äº†ã€‚ä¸Šé¢ <code>getSomeJson()</code> å¦‚æœä½¿ç”¨ <code> done()</code> ä¼šæ›´åŠ å¥å£®:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">getSomeJson</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// when this throws, it won&#39;t be swallowed
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p><code>done()</code> ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ªå¤„ç†é”™è¯¯çš„å›è°ƒâ€”â€”<code>done(callback, errback)</code>ï¼Œå› ä¸ºæ‰€æœ‰çš„ promise éƒ½è¢« resovle äº†ï¼Œæ‰€ä»¥å¦‚æœæœ‰å¼‚å¸¸å‘ç”Ÿï¼Œä½ ä¹Ÿä¼šå¾—åˆ°é€šçŸ¥ã€‚</p>
<blockquote>
<blockquote>
<p><code>done()</code> ä¸å±äº Promises/A+ è§„èŒƒï¼ˆè‡³å°‘ç°åœ¨ä¸æ˜¯ï¼‰ï¼Œæ‰€ä»¥ä½ ä½¿ç”¨çš„ promise åº“å¯èƒ½æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ã€‚</p>
</blockquote>
</blockquote>
<h3 id="a-nameä»rejectä¸­æŒ½æ•‘å›æ¥-ä»-reject-ä¸­æŒ½æ•‘å›æ¥"><!-- raw HTML omitted -->ä» Reject ä¸­æŒ½æ•‘å›æ¥</h3>
<p>æŠŠä¸€ä¸ªè¢« reject çš„ promise æŒ½æ•‘å›æ¥æ˜¯æœ‰å¯èƒ½çš„ã€‚å¦‚æœ <code>then()</code> çš„é”™è¯¯å›è°ƒè¢«è°ƒç”¨äº†ï¼Œä¹‹åçš„ promise å°±ä¼šä»¥ resolve æ¥å“åº”ï¼Œè€Œä¸æ˜¯ reject ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">aMethodThatRejects</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// won&#39;t get here
</span><span class="c1"></span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// since aMethodThatRejects calls reject()
</span><span class="c1"></span>  <span class="c1">// we end up here in the errback
</span><span class="c1"></span>  <span class="k">return</span> <span class="s2">&#34;recovered!&#34;</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after recovery: &#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// we won&#39;t actually get here
</span><span class="c1"></span>  <span class="c1">// since the rejected promise had an errback
</span><span class="c1"></span><span class="p">});</span>

<span class="c1">// the output is
</span><span class="c1">// after recovery: recovered!
</span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœ <code>then()</code> æ²¡æœ‰ä¼ å…¥å¤„ç†é”™è¯¯çš„å›è°ƒï¼Œreject å°±ä¼šè¢«ä¼ é€’åˆ°ä¸‹ä¸€ä¸ª promise ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// notice the two calls to then()
</span><span class="c1"></span><span class="nx">aMethodThatRejects</span><span class="p">().</span><span class="nx">then</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// we won&#39;t get here
</span><span class="c1"></span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;error propagated&#34;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// the output is
</span><span class="c1">// error propagated
</span></code></pre></td></tr></table>
</div>
</div><h2 id="a-namepromiseå¿…é¡»æ˜¯å¼‚æ­¥çš„-promise-å¿…é¡»æ˜¯å¼‚æ­¥çš„"><!-- raw HTML omitted -->Promise å¿…é¡»æ˜¯å¼‚æ­¥çš„</h2>
<p>æœ¬æ–‡å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç”¨åˆ° <code>setTimeout</code>ï¼Œä½†å¾ˆå¿«åˆç§»é™¤äº†ã€‚
æŒ‰ Promises/A+ è§„èŒƒï¼Œpromise å¿…é¡»æ˜¯å¼‚æ­¥çš„ã€‚è¦ç¬¦åˆè¿™ä¸ªè¦æ±‚ä¹Ÿä¸éš¾ï¼Œæˆ‘ä»¬åªè¦æŠŠ <code>handle()</code> çš„ä¸»è¦ä»£ç å°è£…åœ¨ <code>setTimeout</code> é‡Œé¢ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ... as before
</span><span class="c1"></span>  <span class="p">},</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å®é™…ä¸Šï¼ŒçœŸæ­£çš„ promise åº“å¹¶ä¸å€¾å‘ä½¿ç”¨ <code>setTimeout</code>ã€‚å¦‚æœæ˜¯é¢å‘ NodeJS çš„åº“ï¼Œå®ƒå€¾å‘ä½¿ç”¨ <code>process.nextTick</code>ï¼Œå¦‚æœæ˜¯é’ˆå¯¹æµè§ˆå™¨çš„ï¼Œå¯èƒ½ç”¨ <code>setImmediate</code> æˆ–è€… <a href="https://github.com/NobleJS/setImmediate">setImmediate shim</a> (ç›®å‰åªæœ‰ IE æ”¯æŒ setImmediate)ï¼Œåˆæˆ–è€…æ˜¯ Kris Kowal çš„å¼‚æ­¥å·¥å…·åº“ <a href="https://github.com/kriskowal/asap">asap</a>ï¼ˆKris Kowal è¿˜å†™äº† <a href="https://github.com/kriskowal/q">Q</a> ï¼Œä¸€ä¸ªå¾ˆå—æ¬¢è¿çš„ promise åº“ï¼‰</p>
<h3 id="a-nameä¸ºä»€ä¹ˆpromisesaè§„èŒƒè¦æ±‚å¼‚æ­¥-ä¸ºä»€ä¹ˆ-promisesa-è§„èŒƒè¦æ±‚å¼‚æ­¥"><!-- raw HTML omitted -->ä¸ºä»€ä¹ˆ Promises/A+ è§„èŒƒè¦æ±‚å¼‚æ­¥ï¼Ÿ</h3>
<p>å› ä¸ºè¿™æ ·å¯ä»¥ä¿è¯ä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”æ›´åŠ å¯é ï¼Œè¯·çœ‹ä¸‹é¢ä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">doAnOperation</span><span class="p">();</span>
<span class="nx">invokeSomething</span><span class="p">();</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">wrapItAllUp</span><span class="p">);</span>
<span class="nx">invokeSomethingElse</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç ç¨‹åºè°ƒç”¨çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿä»å­—é¢ç†è§£ï¼Œä½ å¯èƒ½è®¤ä¸ºæ˜¯ <code>invokeSomething()</code> -&gt; <code>invokeSomethingElse()</code> -&gt; <code>wrapItAllUp()</code>ã€‚å®é™…ä¸Šå´æ˜¯å–å†³äº promise çš„ resolve æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ã€‚å¦‚æœ <code>doAnOperation()</code> æ˜¯å¼‚æ­¥çš„ï¼Œæµç¨‹å’Œé¢„æƒ³çš„ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œå¦‚æœ <code>doAnOperation()</code> æ˜¯åŒæ­¥çš„ï¼Œæµç¨‹å°±ä¼šå˜æˆï¼š<code>invokeSomething()</code> -&gt; <code>wrapItAllUp()</code> -&gt; <code>invokeSomethingElse()</code>ï¼Œè¿™æ ·å°±ä¸å¥½äº†ã€‚</p>
<p>ä¸ºäº†é¿å¼€è¿™ç§æƒ…å†µï¼Œpromise å¿…é¡»å¼‚æ­¥åœ° resolveï¼Œå³ä½¿æ˜¯ä½ å¹¶ä¸éœ€è¦ã€‚è¿™æ ·ä¼šå‡å°‘æ„å¤–å‘ç”Ÿï¼Œåˆ«äººåœ¨ä½¿ç”¨ promise çš„æ—¶å€™ä¹Ÿä¸ç”¨è€ƒè™‘åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ã€‚</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<p>Promises always require at least one more iteration of the event loop to resolve. This is not necessarily true of the standard callback approach.</p>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
<h2 id="a-nameå‡†å¤‡å°è£…thenpromiseä¹‹å‰-å‡†å¤‡å°è£…-thenpromise-ä¹‹å‰"><!-- raw HTML omitted -->å‡†å¤‡å°è£… then/promise ä¹‹å‰</h2>
<p>ç›®å‰å¸‚é¢ä¸Šå·²ç»æœ‰è®¸å¤šç‰¹æ€§é½å…¨çš„ promise åº“ã€‚<a href="https://github.com/then">then</a> ç»„ç»‡çš„ promise åº“æ˜¯æœ€ç®€å•çš„ã€‚å®ƒçš„ç›®çš„å°±æ˜¯ï¼Œä»¥æœ€ç®€çœçš„æ–¹æ³•å®ç°ä¸€ä¸ªç¬¦åˆ Promises/A+ è§„èŒƒçš„ promise åº“ï¼Œå¦‚æœä½ çœ‹çœ‹å®ƒçš„å®ç°æ–¹æ³•ï¼Œä¼šå‘ç°çœ‹èµ·æ¥å¾ˆçœ¼ç†Ÿã€‚</p>
<blockquote>
<blockquote>
<p>æœ¬æ–‡å®Œæˆæ—¶ï¼Œæœ€ç»ˆçš„ promise ç‰ˆæœ¬çœ‹èµ·æ¥å°±å¾ˆåƒ then/promise çš„ç‰ˆæœ¬ã€‚ä»¥åå¯èƒ½å°±ä¸åƒäº†ï¼Œå› ä¸ºå®ƒä»¬æ­£æ¨åˆ°é‡å†™ promise å®ç°æ–¹æ³•ã€‚</p>
</blockquote>
</blockquote>
<p>æœ¬æ–‡çš„ promise ç‰ˆæœ¬å’Œå®é™…çš„ promise åº“æœ‰äº›ä¸åŒï¼Œå› ä¸ºæœ‰è®¸å¤š Promises/A+ è§„èŒƒé‡Œçš„ç»†èŠ‚æˆ‘å¹¶æ²¡æœ‰æ¶‰åŠã€‚æˆ‘å»ºè®®é˜…è¯» Promises/A+ è§„èŒƒï¼Œå®ƒå¾ˆç®€çŸ­ï¼Œè€Œä¸”é€šä¿—ç›´ç™½ã€‚</p>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>å¦‚æœä½ çœ‹åˆ°è¿™ï¼ŒçœŸè¦è°¢è°¢ä½ èŠ±æ—¶é—´çš„è¯»ä¸‹æ¥äº†ã€‚æˆ‘ä»¬å·²ç»è§¦åŠåˆ° promises çš„æ ¸å¿ƒï¼Œè¿™ä¹Ÿæ˜¯Promises/A+ è§„èŒƒå”¯ä¸€æåŠçš„å†…å®¹ã€‚å¤§éƒ¨åˆ†çš„ promise å®ç°æ–¹æ³•ä¼šæä¾›æ›´å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ <code>all()</code>, <code>spread()</code>, <code>race()</code>, <code>denodeify()</code> ç­‰å¾…ã€‚æˆ‘å»ºè®®é˜…è¯» [API docs for Bluebird] äº†è§£æ›´å¤šå…³äº promise çš„å†…å®¹ã€‚</p>
<p>å½“æˆ‘ç†è§£äº† promise çš„å·¥ä½œåŸç†å’Œæ³¨æ„äº‹é¡¹åï¼Œæˆ‘æ›´å–œæ¬¢å®ƒäº†ï¼Œå®ƒè®©æˆ‘çš„ä»£ç å˜å¾—æ›´åŠ æ•´æ´ã€ä¼˜é›…ã€‚å®ƒè¿˜æœ‰è®¸å¤šå¯ä»¥è°ˆè®ºçš„è¯é¢˜ï¼Œæœ¬æ–‡åªæ˜¯æŠ›ç –å¼•ç‰ã€‚</p>
<h2 id="å»¶ä¼¸é˜…è¯»">å»¶ä¼¸é˜…è¯»</h2>
<p>æ›´å¤šå…³äº promises çš„æ–‡ç« </p>
<ul>
<li><a href="promisejs.org">promisejs.org</a> â€“ great tutorial on promises (already mentioned it a few times)</li>
<li>[Qâ€™s Design Rationale](Qâ€™s Design Rationale) â€“ an article much like this one, but goes into even more detail. By Kris Kowal, creator of Q</li>
<li><a href="https://github.com/domenic/promises-unwrapping/issues/19">Some debate over whether done() is a good thing</a></li>
<li><a href="http://solutionoptimist.com/2013/12/27/javascript-promise-chains-2/">Flattening Promise Chains</a> by Thomas Burleson. A nice article that goes into more advanced usage of promises. If my article is the â€œwhatâ€, then Thomasâ€™s is a nice look at the â€œwhyâ€.</li>
</ul>
<p><strong>Found a mistake?</strong> if I made an error and you want to let me know, please <a href="matt.e.greer@gmail.com">email me</a> or <a href="https://github.com/city41/blog/issues">file an issue</a>. Thanks!</p>
<h2 id="ç¿»è¯‘">ç¿»è¯‘</h2>
<ul>
<li><a href="http://p-baleine.hatenablog.com/entry/2014/03/12/190000">æ—¥æ–‡ç¿»è¯‘</a>, translated by Junpei Tajima</li>
<li><a href="http://p-baleine.hatenablog.com/entry/2014/03/12/190000">ç¹ä½“ä¸­æ–‡ç¿»è¯‘</a>, translated by Jih-Chi Lee</li>
</ul>
  </article>

  


  
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'eb2224abc6c383a0371e',
        clientSecret: '054b7811c14e27f869e637afd14f6f380fa632c1',
        repo: 'chasecs.github.io',
        owner: 'chasecs',
        admin: ['chasecs'],
        id: decodeURI(location.pathname), 
        distractionFreeMode: false 
    });
    (function () {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
            return;
        }
        gitalk.render('gitalk-container');
    })();
</script>


  <ul class="pager article-pager">
    <li class="pager-newer">
      <a href="/posts/2019-07-28-password-hashing-md/" data-toggle="tooltip" data-placement="top"
        title="å¯†ç å“ˆå¸Œ(Password Hashing)">&lt; Newer</a>
    </li>
    <li class="pager-older">
      <a href="/posts/2017-09-28-how-to-build-private-repo-server-for-android-source-code/" data-toggle="tooltip" data-placement="top"
        title="æ­å»ºæ”¯æŒ Repo çš„ Android æºç é•œåƒï¼ˆRepo æœåŠ¡å™¨ï¼‰">Older &gt;</a>
    </li>
  </ul>
</div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2017 ttimehc@gmail.com</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-Github"><a href="http://github.com/chasecs" title="Github">Github</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
