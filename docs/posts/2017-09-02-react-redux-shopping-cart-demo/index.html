<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>React &#43; Redux 应用的开发流程，以购物车为例 - 编程札记 Programming Notes</title>
  <meta property="og:title" content="React &#43; Redux 应用的开发流程，以购物车为例 - 编程札记 Programming Notes" />
  <meta name="twitter:title" content="React &#43; Redux 应用的开发流程，以购物车为例 - 编程札记 Programming Notes" />
  <meta name="description" content="Redux 是最热门的 React 架构。介绍 Redux 的文章不少，官方文档的内容也非常丰富。 本文根据个人对 Redux 的理解，提供一种和官方文档不一样的视角，阐述如何从零开始开发一个 React &#43; Redux 应用...">
  <meta property="og:description" content="Redux 是最热门的 React 架构。介绍 Redux 的文章不少，官方文档的内容也非常丰富。 本文根据个人对 Redux 的理解，提供一种和官方文档不一样的视角，阐述如何从零开始开发一个 React &#43; Redux 应用...">
  <meta name="twitter:description" content="Redux 是最热门的 React 架构。介绍 Redux 的文章不少，官方文档的内容也非常丰富。 本文根据个人对 Redux 的理解，提供一种和官方文档不一样的视角，阐述如何从零开始开发一个 React &#43; Redux 应用...">
  <meta name="author" content="ttimehc"/>
  <meta property="og:site_name" content="编程札记 Programming Notes" />
  <meta property="og:url" content="https://example.com/posts/2017-09-02-react-redux-shopping-cart-demo/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.74.3" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">编程札记 Programming Notes</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

<div class="main" role="main">
  <article class="article">
    
    
    <h1 class="article-title">React &#43; Redux 应用的开发流程，以购物车为例</h1>
    
    <hr class="article-title-bottom">
    <ul class="article-meta">
      <li class="article-meta-date"><time>September 2, 2017</time>
      </li>
      <li class="article-meta-categories">
        <a href="/categories/react/">
          <i class="fas fa-folder"></i>
          React
        </a>&nbsp;
      </li>
    </ul>
    
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#零-react-redux-目录结构">零、 react-redux 目录结构</a>
      <ul>
        <li><a href="#一provider-封装根组件-app">一、<code>&lt;Provider&gt;</code> 封装根组件 <code>&lt;App/&gt;</code></a></li>
      </ul>
    </li>
    <li><a href="#二设计-state-的结构">二、设计 state 的结构</a></li>
    <li><a href="#三展示组件开发">三、展示组件开发</a></li>
    <li><a href="#四容器组件开发">四、容器组件开发</a></li>
    <li><a href="#五action-和-reducer-处理数据">五、Action 和 Reducer 处理数据</a></li>
    <li><a href="#六实现交互操作">六、实现交互操作</a></li>
    <li><a href="#一个-action-引发多个-reducer">一个 Action 引发多个 Reducer</a>
      <ul>
        <li><a href="#参考资料">参考资料</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>
    <p><strong>项目的 repository：<a href="https://github.com/chasecs/react-redux-shopping-cart-demo">react-redux-shopping-cart-demo</a></strong></p>
<p>Redux 是最热门的 React 架构。介绍 Redux 的文章不少，官方文档的内容也非常丰富。<br>
本文根据个人对 Redux 的理解，提供一种和官方文档不一样的视角，阐述如何从零开始开发一个 React + Redux 应用。</p>
<p>阅读之前，假设你已经了解 Redux 的三个核心概念：Action，Reducer，Store，并且知道三者在 Redux 的工作流程所承担的角色和功能。<br>
文中使用的实例 “shopping-cart”，参考自官方的示例<a href="https://github.com/reactjs/redux/tree/master/examples/shopping-cart">shopping-cart</a>，虽然实现同样的效果，但是代码有较大的差异。</p>
<h2 id="零-react-redux-目录结构">零、 react-redux 目录结构</h2>
<p>使用 <code>create-react-app</code> 创建项目，并安装相关依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ create-react-app react-redux-shopping-cart-demo
$ <span class="nb">cd</span> react-redux-shopping-cart-demo
$ npm i -S redux react-redux
</code></pre></td></tr></table>
</div>
</div><p>在 <code>src/</code> 下创建项目的目录结构:</p>
<pre><code>|- /src
  |- /actions
  |- /constants
    |- action_types.js
  |- /components
  |- /containers
    |- app.js
  |- /reducers
    |- index.js
  |- index.js
</code></pre><h3 id="一provider-封装根组件-app">一、<code>&lt;Provider&gt;</code> 封装根组件 <code>&lt;App/&gt;</code></h3>
<p>使用 <code>react-redux</code> 提供 <code>&lt;Provider&gt;</code> ，它提供 store 属性，并封装应用的根组件 <code>App</code>，所有子组件都可以访问 state。
<code>src/index.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">render</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">createStore</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;redux&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Provider</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-redux&#39;</span>
<span class="kr">import</span> <span class="nx">App</span> <span class="nx">from</span> <span class="s1">&#39;./containers/App&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">reducer</span> <span class="nx">from</span> <span class="s1">&#39;./reducers&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">reducer</span><span class="p">);</span>

<span class="nx">render</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">Provider</span> <span class="nx">store</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">App</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/Provider&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>store 由 <code>Redux</code> 提供，它需要 Reducer 作为参数。因此，我们还需要创建 App 和 Reducer。<br>
先创建 Reducer，因为项目刚刚创建，我们可以创建一个没有内容的 Reducer。<br>
<code>reducers/index.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span> <span class="nx">combineReducers</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;redux&#39;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">combineReducers</span><span class="p">({});</span>
</code></pre></td></tr></table>
</div>
</div><p>其次是 App，可以把它看作是应用的首页，同样可以先建一个没有实际内容的页面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>

<span class="kr">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">hello</span> <span class="nx">world</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">App</span>
</code></pre></td></tr></table>
</div>
</div><p>这样，一个 React + Redux 应用就可以通过 <code>npm start</code> 运行起来了。你也可以把它看作是一个 boilerplate。</p>
<h2 id="二设计-state-的结构">二、设计 state 的结构</h2>
<p>上一个步骤完成了项目的初始化，在开始真正的开发之前，最好先思考一下整个应用的 state 结构（state shape）。<br>
state 的设计可以化整为零，比如以 Container（容器组件）为单位划分，该部分 state 的初始值定义在和 Container 对应的 Reducer 中，该 Reducer 就处理这个部分的 state。<br>
以 shopping cart 应用为例，页面展示上需要两个独立的容器组件：</p>
<ul>
<li>ProductContainer，用于显示库存商品 products ；</li>
<li>CartContainer，用于显示购物车的商品；</li>
</ul>
<p>因此，state 的结构可以设计如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">products</span><span class="p">,</span>
  <span class="nx">cart</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>至于 products 和 cart 的数据类型应该是怎样，可以在各自的 Reducer 里在具体定义。</p>
<h2 id="三展示组件开发">三、展示组件开发</h2>
<p>步骤一只是搭建了 react/redux 框架，里面并没有我们的数据和 UI，如何把这些呈现出来？<br>
在 React/Redux，数据由 Action 提供，它可以是从 api 获取的，也可以是本地的数据。<br>
而 UI 部分，React-Redux 将所有组件分成两大类：展示组件（presentational component）和容器组件（container component），分别保存在 <code>components/</code> 和 <code>containers/</code> 两个目录。</p>
<p>展示组件负责视觉呈现，和 redux 几乎没有联系。如果是复杂的应用，还可以把展示组件分别保存在 <code>components/</code> 和 <code>pages/</code> 两个目录，<code>pages/</code> 对应页面，由 component 按需组合起来。<br>
容器组件负责管理数据和业务逻辑，这里的数据并不是直接从 Action 获取，而是从 state 获取，而 Action 和 state 需要通过 Reducer 才能互动。</p>
<p>因为展示组件和 redux 关系不大，可以先行开发，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="o">|-</span> <span class="err">/components</span>
  <span class="o">|-</span> <span class="nx">product</span><span class="p">.</span><span class="nx">js</span>
  <span class="o">|-</span> <span class="nx">product_item</span><span class="p">.</span><span class="nx">js</span>
  <span class="o">|-</span> <span class="nx">products_list</span><span class="p">.</span><span class="nx">js</span>
  <span class="o">|-</span> <span class="nx">cart</span><span class="p">.</span><span class="nx">js</span>
</code></pre></td></tr></table>
</div>
</div><p>展示组件的开发这里不做介绍，可以直接看源码 <code>[components](https://github.com/chasecs/react-redux-shopping-cart-demo/tree/master/src/components)</code></p>
<h2 id="四容器组件开发">四、容器组件开发</h2>
<p>展示组件完成后，要使它和数据产生联系，需要通过容器组件。<br>
因为容器组件相对复杂一些，所以不采用 const FuntionName 的方式来创建，使用 class XX extends Component 创建。<br>
创建容器组件 <code>products_list_container.js</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Component</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>
<span class="kr">import</span> <span class="nx">PropTypes</span> <span class="nx">from</span> <span class="s1">&#39;prop-types&#39;</span>
<span class="kr">import</span> <span class="nx">ProductsList</span> <span class="nx">from</span> <span class="s1">&#39;../components/products_list&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ProductItem</span> <span class="nx">from</span> <span class="s1">&#39;../components/product_item&#39;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">ProductsListContainer</span> <span class="kr">extends</span> <span class="nx">Component</span> <span class="p">{</span>

  <span class="kr">static</span> <span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">products</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">arrayOf</span><span class="p">(</span><span class="nx">PropTypes</span><span class="p">.</span><span class="nx">shape</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">number</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
      <span class="nx">price</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">number</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
      <span class="nx">inventory</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">number</span><span class="p">.</span><span class="nx">isRequired</span>
    <span class="p">})).</span><span class="nx">isRequired</span><span class="p">,</span>
    <span class="nx">addToCart</span><span class="o">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">isRequired</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">ProductsList</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;Product List&#34;</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">product</span> <span class="p">=&gt;</span>
          <span class="o">&lt;</span><span class="nx">ProductItem</span>
            <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
            <span class="nx">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
            <span class="nx">onAddToCartClicked</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{}}</span>
          <span class="o">/&gt;</span>
        <span class="p">)}</span>
      <span class="o">&lt;</span><span class="err">/ProductsList&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果仅仅是上述的代码，<code>ProductsListContainer</code> 仍然只是一个展示组件，把它变为容器组件，你还需要 <code>react-redux</code> 提供的 <code>connect()</code> 方法，所以，在文件最后加上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">....</span>
<span class="nx">ProductsListContainer</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">()(</span><span class="nx">ProductsListContainer</span><span class="p">);</span>
<span class="kr">export</span> <span class="k">default</span> <span class="nx">ProductsListContainer</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>下一步是往 <code>ProductsListContainer</code> 里面传入 <code>products</code> 数据和 <code>onAddToCartClicked</code> 方法。<br>
这里需要的数据是：库存商品数据，因此，可以在 <code>constants/action_types.js</code> 里定义一个 <code>type</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">SHOW_INVENTORY</span> <span class="o">=</span> <span class="s1">&#39;SHOW_INVENTORY&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>传入数据可以调用 <code>mapStateToProps</code> 方法，把数据传给组件。
修改 <code>products_list_container.js</code>, 最终代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>
<span class="kr">import</span> <span class="nx">PropTypes</span> <span class="nx">from</span> <span class="s1">&#39;prop-types&#39;</span>
<span class="kr">import</span> <span class="nx">ProductsList</span> <span class="nx">from</span> <span class="s1">&#39;../components/products_list&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Product</span> <span class="nx">from</span> <span class="s1">&#39;../components/product&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">connect</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-redux&#39;</span>

<span class="kr">const</span> <span class="nx">ProductsContainer</span> <span class="o">=</span><span class="p">({</span><span class="nx">products</span><span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">ProductsList</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;hehe&#34;</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">product</span> <span class="p">=&gt;</span>
      <span class="o">&lt;</span><span class="nx">Product</span>
        <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
        <span class="nx">title</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span>
        <span class="nx">price</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}</span>
        <span class="nx">inventory</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">inventory</span><span class="p">}</span>
      <span class="o">/&gt;</span>
    <span class="p">)}</span>
  <span class="o">&lt;</span><span class="err">/ProductsList&gt;</span>
<span class="p">)</span>

<span class="kr">const</span> <span class="nx">mapStateToProps</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span>
  <span class="cm">/* 不规范的代码 BEGIN*/</span>
  <span class="nx">products</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;iPad 4 Mini&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">500.01</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;H&amp;M T-Shirt White&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">10.99</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">10</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;Charli XCX - Sucker CD&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">5</span><span class="p">}</span>
  <span class="p">]</span>
  <span class="cm">/* 不规范的代码是 END*/</span>
<span class="p">})</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">mapStateToProps</span><span class="p">)(</span><span class="nx">ProductsContainer</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在 <code>containers/app.js</code> 修改 <code>&lt;App&gt;</code> 组件，加入 <code>ProductsListContainer</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">ProductsListContainer</span> <span class="nx">from</span> <span class="s1">&#39;./products_list_container&#39;</span>

<span class="kr">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">ProductsListContainer</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>再运行一下，就可以在浏览器页面看到商品的列表了。</p>
<h2 id="五action-和-reducer-处理数据">五、Action 和 Reducer 处理数据</h2>
<p>正如 <code>ProductsContainer.js</code> 里标注的，<code>mapStateToProps</code> 里的代码是错误的，数据不能直接赋值。正确的做法是，把 Redux 的 store 里保存的 state 输出为组件的 props。 <br>
不过，store 里的 state 又从哪里获取？<br>
按照 Redux 的工作流程，它应该从 Action 和 Reducer 产生。Action 提供原始数据，经过 Reducer 的处理，更新到 state。<br>
先在 <code>actions/products_action.js</code> 实现这个 Action：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">types</span> <span class="nx">from</span> <span class="s1">&#39;../constants/action_types&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">showInventory</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">products</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="o">:</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;iPad 4 Mini&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">500.01</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="mi">2</span><span class="o">:</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;H&amp;M T-Shirt White&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">10.99</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">10</span><span class="p">},</span>
    <span class="mi">3</span><span class="o">:</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;Charli XCX - Sucker CD&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="o">:</span> <span class="mf">19.99</span><span class="p">,</span> <span class="s2">&#34;inventory&#34;</span><span class="o">:</span> <span class="mi">5</span><span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">types</span><span class="p">.</span><span class="nx">SHOW_INVENTORY</span><span class="p">,</span>
    <span class="nx">products</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>数据要经过 Reducer 才能和 state 产生关联，新建一个 <code>reducers/products_reducer.js</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">types</span> <span class="nx">from</span> <span class="s1">&#39;../constants/action_types&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kr">const</span> <span class="nx">productsReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">types</span><span class="p">.</span><span class="nx">SHOW_INVENTORY</span><span class="o">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">action</span><span class="p">.</span><span class="nx">products</span><span class="p">)</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">productsReducer</span>
</code></pre></td></tr></table>
</div>
</div><p>把 <code>productsReducer</code> 添加到 <code>reducers/index.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">products</span> <span class="nx">from</span> <span class="s1">&#39;./products_reducer&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">combineReducers</span><span class="p">({</span>
  <span class="nx">products</span><span class="o">:</span> <span class="nx">productsReducer</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>现在 Action 已经有了，但是还需要调用 <code>dispatch(action)</code> 这个方法，使用 <code>mapDispatchToProps</code> 方法。如果向 <code>mapDispatchToProps</code> 返回一个对象，它的 key 对应的 value 必须是一个返回 Action 对象的函数，调用该函数时，返回的 Action 会由 Redux 自动 <code>dispatch</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span> <span class="nx">showInventory</span><span class="p">,</span> <span class="nx">addToCart</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../actions/products_action&#39;</span><span class="p">;</span>
<span class="p">...</span>
<span class="kr">const</span> <span class="nx">mapDispatchToProps</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">showInventory</span><span class="p">,</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="k">default</span> <span class="nx">connect</span><span class="p">(</span>
  <span class="nx">mapStateToProps</span><span class="p">,</span>
  <span class="nx">mapDispatchToProps</span>
<span class="p">)(</span><span class="nx">ProductsListContainer</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>showInventory</code> 方法就可以在 <code>ProductsListContainer</code> 通过 <code>this.props</code> 来访问</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">showInventory</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="nx">showInventory</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这一步也类似于现实应用中向api请求数据。<br>
<code>showInventory()</code> 调用成功后，store 中的 state 就已经更新了。容器组件就可以通过 <code>mapStateToProps</code> 获取 state 并映射到 props。
因为 <code>state.products</code> 的格式不是和展示组件要求的格式不太一样，所以我们要用 <code>parseProducts</code> 转换一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">parseProducts</span> <span class="o">=</span> <span class="p">(</span><span class="nx">products</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">mappedProducts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">products</span><span class="p">){</span>
    <span class="nx">mappedProducts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">products</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">mappedProducts</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">mapStateToProps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
  <span class="p">{</span><span class="nx">products</span><span class="o">:</span> <span class="nx">parseProducts</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">products</span><span class="p">)}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>同样，最终的 <code>products</code> 可以在 <code>ProductsListContainer</code> 通过 <code>this.props</code> 来访问，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">render</span><span class="p">(){</span>
    <span class="kr">const</span> <span class="p">{</span><span class="nx">products</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">ProductsList</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;Product List&#34;</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">product</span> <span class="p">=&gt;</span>
          <span class="o">&lt;</span><span class="nx">ProductItem</span>
            <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
            <span class="nx">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
            <span class="nx">onAddToCartClicked</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{}}</span>
          <span class="o">/&gt;</span>
        <span class="p">)}</span>
      <span class="o">&lt;</span><span class="err">/ProductsList&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再运行一下，就可以在浏览器页面看到商品的列表了。至此，这个应用已经是一个完整地运用 redux 的 Action，Reducer，Store。</p>
<h2 id="六实现交互操作">六、实现交互操作</h2>
<p>迄今为止，我们的应用只是展示了商品，作为一个购物车应用，还需要增加交互操作。下来将实现 addToCart 按钮的功能。<br>
在 Redux 的工作流程里，一个引发 state 变化的 function，必须是一次 dispatch(Action)。<br>
先不考虑购物车 <code>CartContainer</code> 的情况，对于 <code>ProductsContainer</code> 这个容器组件，每点击一下，库存数量就应该减少一个。</p>
<p>实现 <code>ADD_TO_CART</code> 的 Action：
<code>constants/action_types.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ADD_TO_CART</span> <span class="o">=</span> <span class="s1">&#39;ADD_TO_CART&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>actions/products_action.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">addToCart</span> <span class="o">=</span> <span class="nx">productId</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ADD_TO_CART</span><span class="p">,</span>
    <span class="nx">productId</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 Reducer 实现对应的方法，修改 <code>reducers/products_reducer.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">decreaseInventory</span> <span class="o">=</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">product</span><span class="p">,</span>
    <span class="nx">inventory</span><span class="o">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">inventory</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">productsReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">types</span><span class="p">.</span><span class="nx">SHOW_INVENTORY</span><span class="o">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">action</span><span class="p">.</span><span class="nx">products</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ADD_TO_CART</span><span class="o">:</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">productId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">action</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">productId</span><span class="p">]</span><span class="o">:</span> <span class="nx">decreaseInventory</span><span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="nx">productId</span><span class="p">])</span>
      <span class="p">}</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>修改 <code>products_list_container.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">...</span>
<span class="nx">render</span><span class="p">(){</span>
  <span class="kr">const</span> <span class="p">{</span><span class="nx">products</span><span class="p">,</span> <span class="nx">addToCart</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">ProductsList</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;Product List&#34;</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">product</span> <span class="p">=&gt;</span>
        <span class="o">&lt;</span><span class="nx">ProductItem</span>
          <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
          <span class="nx">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
          <span class="nx">onAddToCartClicked</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">addToCart</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
        <span class="o">/&gt;</span>
      <span class="p">)}</span>
    <span class="o">&lt;</span><span class="err">/ProductsList&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="kr">const</span> <span class="nx">mapDispatchToProps</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">showInventory</span><span class="p">,</span>
  <span class="nx">addToCart</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这样，<code>ProductsContainer</code> 的 <code>addToCart</code> 功能就已经实现了，每点击一次，对应商品的数量就会减少一个。</p>
<h2 id="一个-action-引发多个-reducer">一个 Action 引发多个 Reducer</h2>
<p>在商品列表中，点击 &ldquo;Add to Cart&rdquo; 按钮之后，发生的变化不仅是库存减少，还有购物车物品增多、购物金额变化。 <br>
因为库存和购物车被划分在不同的 Reducer 里，所以就会出现一个 Action 触发两个 Reducer 的情况。<br>
实现 <code>reducers/cart_reducer.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">types</span> <span class="nx">from</span> <span class="s1">&#39;../constants/action_types&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">addedIds</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">quantityById</span><span class="o">:</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">addProduct</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">.</span><span class="nx">addedIds</span><span class="p">,</span> <span class="nx">productId</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">productId</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">[...</span><span class="nx">state</span><span class="p">,</span> <span class="nx">productId</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">addQuantity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">.</span><span class="nx">quantityById</span><span class="p">,</span> <span class="nx">productId</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">productId</span><span class="p">]</span><span class="o">:</span> <span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="nx">productId</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kr">const</span> <span class="nx">cartReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ADD_TO_CART</span><span class="o">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">addedIds</span><span class="o">:</span> <span class="nx">addProduct</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">addedIds</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">productId</span><span class="p">),</span>
        <span class="nx">quantityById</span><span class="o">:</span> <span class="nx">addQuantity</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">quantityById</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">productId</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">cart</span>
</code></pre></td></tr></table>
</div>
</div><p>将 <code>cartReducer</code> 加入 <code>reducers/index.js</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">....</span>
<span class="o">+</span><span class="kr">import</span> <span class="nx">cartReducer</span> <span class="nx">from</span> <span class="s1">&#39;./cart_reducer&#39;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">combineReducers</span><span class="p">({</span>
  <span class="p">...</span>
<span class="o">+</span>  <span class="nx">cart</span><span class="o">:</span> <span class="nx">cartReducer</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>实现 <code>CartContainer</code>,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>
<span class="kr">import</span> <span class="nx">PropTypes</span> <span class="nx">from</span> <span class="s1">&#39;prop-types&#39;</span>
<span class="kr">import</span> <span class="nx">Cart</span> <span class="nx">from</span> <span class="s1">&#39;../components/cart&#39;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">connect</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-redux&#39;</span>

<span class="kr">class</span> <span class="nx">CartContainer</span> <span class="kr">extends</span> <span class="nx">Component</span> <span class="p">{</span>

  <span class="nx">render</span><span class="p">(){</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">products</span><span class="p">,</span> <span class="nx">total</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>

    <span class="k">return</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">Cart</span>
        <span class="nx">products</span><span class="o">=</span><span class="p">{</span><span class="nx">products</span><span class="p">}</span>
        <span class="nx">total</span><span class="o">=</span><span class="p">{</span><span class="nx">total</span><span class="p">}</span>
        <span class="nx">onCheckoutClicked</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">)}</span>
      <span class="o">/&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">productsInCart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">products</span><span class="p">,</span> <span class="nx">cart</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">cart</span><span class="p">.</span><span class="nx">quantityById</span><span class="p">){</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="p">...</span><span class="nx">products</span><span class="p">[</span><span class="nx">id</span><span class="p">],</span>
      <span class="nx">quantity</span><span class="o">:</span><span class="nx">cart</span><span class="p">.</span><span class="nx">quantityById</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="p">});</span>
    <span class="nx">total</span> <span class="o">+=</span> <span class="nx">products</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">price</span> <span class="o">*</span> <span class="nx">cart</span><span class="p">.</span><span class="nx">quantityById</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">products</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span>
    <span class="nx">total</span><span class="o">:</span> <span class="nx">total</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">mapStateToProps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">productsInCart</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">connect</span><span class="p">(</span>
  <span class="nx">mapStateToProps</span><span class="p">,</span>
<span class="p">)(</span><span class="nx">CartContainer</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><p>其中 <code>productsInCart</code> 方法用于解析 state 中的购物车数据，输出我们需要的格式，从而在组件中渲染出来。
至此，点击 &ldquo;add to cart&rdquo; 按钮之后，会同时发生库存减少、购物车商品数量、金额变化，最基本的购物车 demo 就已经完成。</p>
<p>当然，目前这个购物车是十分简陋的，如果想继续利用它来熟悉 Redux 或者 React，还有许多可以开发的方向，比如：减少购物车商品数量，购物车商品可选、全选，加入 React-Router，页面样式&hellip;</p>
<p>(完)</p>
<h3 id="参考资料">参考资料</h3>
<ul>
<li><a href="http://redux.js.org/">Read Me · Redux</a></li>
<li><a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#api">react-redux API</a></li>
<li><a href="https://github.com/reactjs/redux/tree/master/examples/shopping-cart">shopping-cart</a></li>
<li><a href="https://github.com/tj/frontend-boilerplate">tj/frontend-boilerplate</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html">Redux 入门教程（三）：React-Redux 的用法</a></li>
</ul>
  </article>

  


  
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'eb2224abc6c383a0371e',
        clientSecret: '054b7811c14e27f869e637afd14f6f380fa632c1',
        repo: 'chasecs.github.io',
        owner: 'chasecs',
        admin: ['chasecs'],
        id: decodeURI(location.pathname), 
        distractionFreeMode: false 
    });
    (function () {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
            return;
        }
        gitalk.render('gitalk-container');
    })();
</script>


  <ul class="pager article-pager">
    <li class="pager-newer">
      <a href="/posts/2017-09-28-how-to-build-private-repo-server-for-android-source-code/" data-toggle="tooltip" data-placement="top"
        title="搭建支持 Repo 的 Android 源码镜像（Repo 服务器）">&lt; Newer</a>
    </li>
    <li class="pager-older">
      <a href="/posts/2017-08-09-react_native_packing_native_module_for_android_n_ios/" data-toggle="tooltip" data-placement="top"
        title="React Native 原生模块库打包指南">Older &gt;</a>
    </li>
  </ul>
</div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2017 ttimehc@gmail.com</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-Github"><a href="http://github.com/chasecs" title="Github">Github</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
